<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Mixtraxer Pro</title>
  <style>
    :root {
      --bg: #0a0a0c;
      --panel: #141417;
      --accent: #00ff88;
      --accent-dim: rgba(0, 255, 136, 0.1);
      --text: #e0e0e0;
      --danger: #ff4444;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* --- Header / Master Controls --- */
    header {
      background: var(--panel);
      padding: 1.5rem 2rem;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 2rem;
    }

    .master-group {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .master-btn {
      background: var(--accent);
      color: black;
      font-weight: bold;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 2rem;
      cursor: pointer;
      font-size: 1rem;
      transition: transform 0.1s, opacity 0.2s;
    }

    .master-btn:hover { opacity: 0.9; }
    .master-btn:active { transform: scale(0.95); }
    .master-btn.secondary { background: #333; color: white; }

    /* --- Main Layout --- */
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 1px;
      background: #222; /* Divider line */
    }

    .channel-sec {
      flex: 1;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
      overflow-y: auto;
    }

    h2 {
      margin-top: 0;
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--accent);
      display: flex;
      justify-content: space-between;
    }

    /* --- Controls & Inputs --- */
    .control-box {
      background: var(--panel);
      padding: 1rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
    }

    .transport {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      justify-content: center;
    }

    .transport button {
      background: #222;
      border: 1px solid #333;
      color: white;
      padding: 0.6rem;
      border-radius: 0.5rem;
      cursor: pointer;
      flex: 1;
    }

    .transport button:hover { background: #333; }

    input[type="file"] {
      font-size: 0.8rem;
      width: 100%;
      margin-bottom: 1rem;
    }

    label {
      font-size: 0.8rem;
      display: block;
      margin-bottom: 0.5rem;
      color: #888;
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    /* --- Visualizer & Playlist --- */
    canvas {
      width: 100%;
      height: 80px;
      background: #000;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .marquee-container {
      background: #000;
      padding: 0.5rem;
      border-radius: 0.3rem;
      margin-bottom: 1rem;
      overflow: hidden;
    }

    .marquee {
      white-space: nowrap;
      display: inline-block;
      animation: scroll 10s linear infinite;
      color: var(--accent);
      font-family: monospace;
    }

    @keyframes scroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    .tracklist {
      flex: 1;
      background: var(--panel);
      border-radius: 0.5rem;
      overflow-y: auto;
      font-size: 0.9rem;
    }

    .trackitem {
      display: flex;
      align-items: center;
      padding: 0.6rem;
      border-bottom: 1px solid #222;
      gap: 0.5rem;
    }

    .trackitem:hover { background: #1a1a1f; }
    .trackitem span { flex: 1; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .trackitem button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 2px 5px;
    }
    .trackitem button:hover { color: var(--danger); }

    .settings-row {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    select {
        background: #222;
        color: white;
        border: 1px solid #444;
        padding: 0.4rem;
        border-radius: 0.4rem;
    }

  </style>
</head>

<body>

  <header>
    <div class="master-group">
      <h1 style="margin:0; font-size: 1.5rem;">MIXTRAXER <span style="font-weight: 300; opacity: 0.5;">PRO</span></h1>
    </div>

    <div class="master-group">
        <button class="master-btn" id="playBoth">▶ PLAY BOTH</button>
        <button class="master-btn secondary" id="pauseBoth">⏸ PAUSE BOTH</button>
        
        <div class="settings-row">
            <button class="master-btn secondary" id="toggleOrbit">360 Mode: OFF</button>
            <label>Speed <input id="speed" type="range" min="0" max="5" value="1" style="width: 80px;"></label>
            <select id="playbackMode">
                <option value="cut">Shortest</option>
                <option value="long">Longest</option>
            </select>
        </div>
    </div>
  </header>

  <main>
    <section class="channel-sec">
      <h2>LEFT EAR <span>L</span></h2>
      <div class="control-box">
        <input id="leftFiles" type="file" accept="audio/*" multiple>
        <div class="transport">
          <button id="prevLeft">⏮</button>
          <button id="playLeft">▶</button>
          <button id="pauseLeft">⏸</button>
          <button id="nextLeft">⏭</button>
        </div>
        <label>VOLUME</label>
        <input id="leftVol" type="range" min="0" max="1" step="0.01" value="0.8">
      </div>

      <canvas id="leftWave"></canvas>
      
      <div class="marquee-container">
        <div id="leftNow" class="marquee">No track loaded...</div>
      </div>

      <div id="leftList" class="tracklist"></div>
    </section>

    <section class="channel-sec">
      <h2>RIGHT EAR <span>R</span></h2>
      <div class="control-box">
        <input id="rightFiles" type="file" accept="audio/*" multiple>
        <div class="transport">
          <button id="prevRight">⏮</button>
          <button id="playRight">▶</button>
          <button id="pauseRight">⏸</button>
          <button id="nextRight">⏭</button>
        </div>
        <label>VOLUME</label>
        <input id="rightVol" type="range" min="0" max="1" step="0.01" value="0.8">
      </div>

      <canvas id="rightWave"></canvas>

      <div class="marquee-container">
        <div id="rightNow" class="marquee">No track loaded...</div>
      </div>

      <div id="rightList" class="tracklist"></div>
    </section>
  </main>

  <script>
    let ac, leftElem, rightElem, leftSrc, rightSrc, leftGain, rightGain, merger, leftPanner, rightPanner, t = 0, orbit = false, rotate360 = false;
    let leftTracks = [], rightTracks = [], leftIndex = 0, rightIndex = 0, leftAnalyzer, rightAnalyzer, leftCtx, rightCtx, leftData, rightData;

    function ensureCtx() { 
        if (!ac) {
            ac = new (window.AudioContext || window.webkitAudioContext)();
            makeElements();
        }
        if (ac.state === 'suspended') ac.resume();
    }

    function makeElements() {
      leftElem = new Audio(); rightElem = new Audio();
      leftSrc = ac.createMediaElementSource(leftElem);
      rightSrc = ac.createMediaElementSource(rightElem);
      leftGain = ac.createGain(); rightGain = ac.createGain();
      leftAnalyzer = ac.createAnalyser(); rightAnalyzer = ac.createAnalyser();
      leftAnalyzer.fftSize = 256;
      rightAnalyzer.fftSize = 256;
      merger = ac.createChannelMerger(2);
      leftCtx = leftWave.getContext("2d"); rightCtx = rightWave.getContext("2d");
      leftData = new Uint8Array(leftAnalyzer.frequencyBinCount);
      rightData = new Uint8Array(rightAnalyzer.frequencyBinCount);
      connectStereo();
    }

    function connectStereo() {
      disconnectAll();
      leftSrc.connect(leftAnalyzer).connect(leftGain).connect(merger, 0, 0);
      rightSrc.connect(rightAnalyzer).connect(rightGain).connect(merger, 0, 1);
      merger.connect(ac.destination);
    }

    function connectOrbit() {
      disconnectAll();
      leftPanner = ac.createPanner(); rightPanner = ac.createPanner();
      [leftPanner, rightPanner].forEach(p => { p.panningModel = 'HRTF'; p.distanceModel = 'inverse'; });
      leftSrc.connect(leftAnalyzer).connect(leftPanner).connect(leftGain).connect(ac.destination);
      rightSrc.connect(rightAnalyzer).connect(rightPanner).connect(rightGain).connect(ac.destination);
    }

    function disconnectAll() { 
        try { 
            leftSrc.disconnect(); rightSrc.disconnect(); 
            leftGain.disconnect(); rightGain.disconnect(); 
            if(merger) merger.disconnect(); 
        } catch(e) {} 
    }

    function playTrack(side) {
        const tracks = side === "left" ? leftTracks : rightTracks;
        const index = side === "left" ? leftIndex : rightIndex;
        const elem = side === "left" ? leftElem : rightElem;
        
        if (!tracks.length) return;
        
        elem.src = URL.createObjectURL(tracks[index]);
        elem.play();
        updateNowPlaying(side, tracks[index].name);
    }

    function updateNowPlaying(side, name) {
      const el = side === "left" ? leftNow : rightNow;
      el.textContent = name ? `NOW PLAYING: ${name}` : "No track loaded...";
    }

    function nextTrack(side) {
      if (side === "left" && leftTracks.length) { leftIndex = (leftIndex + 1) % leftTracks.length; playTrack("left"); }
      if (side === "right" && rightTracks.length) { rightIndex = (rightIndex + 1) % rightTracks.length; playTrack("right"); }
    }

    function prevTrack(side) {
      if (side === "left" && leftTracks.length) { leftIndex = (leftIndex - 1 + leftTracks.length) % leftTracks.length; playTrack("left"); }
      if (side === "right" && rightTracks.length) { rightIndex = (rightIndex - 1 + rightTracks.length) % rightTracks.length; playTrack("right"); }
    }

    function visualize() {
      if (!leftAnalyzer || !rightAnalyzer) return;
      leftAnalyzer.getByteFrequencyData(leftData);
      rightAnalyzer.getByteFrequencyData(rightData);
      
      leftCtx.clearRect(0, 0, 300, 80); 
      rightCtx.clearRect(0, 0, 300, 80);
      
      leftCtx.fillStyle = '#00ff88';
      rightCtx.fillStyle = '#00ff88';

      for (let i = 0; i < leftData.length; i++) { 
        let h = (leftData[i] / 255) * 80; 
        leftCtx.fillRect(i * 3, 80 - h, 2, h); 
      }
      for (let i = 0; i < rightData.length; i++) { 
        let h = (rightData[i] / 255) * 80; 
        rightCtx.fillRect(i * 3, 80 - h, 2, h); 
      }
      requestAnimationFrame(visualize);
    }

    function animate() {
      if (!rotate360) return;
      t += 0.02 * parseFloat(speed.value);
      const lx = Math.cos(t), lz = Math.sin(t);
      const rx = Math.cos(t + Math.PI), rz = Math.sin(t + Math.PI);
      if (leftPanner && rightPanner) {
        leftPanner.positionX.value = lx; leftPanner.positionZ.value = lz;
        rightPanner.positionX.value = rx; rightPanner.positionZ.value = rz;
      }
      requestAnimationFrame(animate);
    }

    function renderList(side) {
      const container = side === "left" ? leftList : rightList;
      const tracks = side === "left" ? leftTracks : rightTracks;
      container.innerHTML = "";
      tracks.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "trackitem";
        const name = document.createElement("span");
        name.textContent = `${i+1}. ${f.name}`;
        name.onclick = () => { 
            ensureCtx();
            if (side === "left") { leftIndex = i; playTrack("left"); } 
            else { rightIndex = i; playTrack("right"); } 
        };
        const remove = document.createElement("button");
        remove.textContent = "✕";
        remove.onclick = e => { e.stopPropagation(); tracks.splice(i, 1); renderList(side); };
        div.append(name, remove);
        container.appendChild(div);
      });
    }

    // Event Listeners
    leftFiles.onchange = () => { leftTracks = Array.from(leftFiles.files); renderList("left"); };
    rightFiles.onchange = () => { rightTracks = Array.from(rightFiles.files); renderList("right"); };

    playLeft.onclick = () => { ensureCtx(); playTrack("left"); leftElem.onended = () => nextTrack("left"); visualize(); };
    playRight.onclick = () => { ensureCtx(); playTrack("right"); rightElem.onended = () => nextTrack("right"); visualize(); };
    pauseLeft.onclick = () => leftElem.pause();
    pauseRight.onclick = () => rightElem.pause();

    // Play Both Logic
    playBoth.onclick = () => {
        ensureCtx();
        if (leftTracks.length) { playTrack("left"); leftElem.onended = () => nextTrack("left"); }
        if (rightTracks.length) { playTrack("right"); rightElem.onended = () => nextTrack("right"); }
        visualize();
    };

    pauseBoth.onclick = () => {
        if(leftElem) leftElem.pause();
        if(rightElem) rightElem.pause();
    };

    toggleOrbit.onclick = () => {
      ensureCtx();
      rotate360 = !rotate360;
      toggleOrbit.textContent = `360 Mode: ${rotate360 ? 'ON' : 'OFF'}`;
      toggleOrbit.style.background = rotate360 ? 'var(--accent)' : '#333';
      toggleOrbit.style.color = rotate360 ? 'black' : 'white';
      if (rotate360) { connectOrbit(); animate(); }
      else { connectStereo(); }
    }

    leftVol.oninput = () => { if (leftGain) leftGain.gain.value = parseFloat(leftVol.value) }
    rightVol.oninput = () => { if (rightGain) rightGain.gain.value = parseFloat(rightVol.value) }

    prevLeft.onclick = () => prevTrack("left");
    nextLeft.onclick = () => nextTrack("left");
    prevRight.onclick = () => prevTrack("right");
    nextRight.onclick = () => nextTrack("right");
  </script>
</body>
</html>